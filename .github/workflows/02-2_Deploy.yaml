name: 02-2 - Deploy to Azure VM

on:
  workflow_call

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Download deployment artifacts
        uses: actions/download-artifact@v4
        with:
          name: deployment-artifacts
          path: ./deployment/

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.AZURE_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.AZURE_VM_HOST }} >> ~/.ssh/known_hosts

      - name: Copy deployment files to server
        run: |
          scp -r ./deployment/* ${{ secrets.AZURE_VM_USER }}@${{ secrets.AZURE_VM_HOST }}:~/cesizen/

      - name: Deploy application
        run: |
          ssh ${{ secrets.AZURE_VM_USER }}@${{ secrets.AZURE_VM_HOST }} << 'ENDSSH'
            cd ~/cesizen

            # Configurer les variables d'environnement
            export SQL_SERVER_PASSWORD="${{ secrets.SQL_SERVER_PASSWORD }}"

            # Se connecter au registre Docker
            echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

            # Mettre Ã  jour le fichier docker-compose avec les bonnes images
            sed -i 's|ghcr.io/votre-username/cesizen-api:latest|${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-api:latest|g' docker-compose.yml
            sed -i 's|ghcr.io/votre-username/cesizen-ui:latest|${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-ui:latest|g' docker-compose.yml

            # ExÃ©cuter le script de dÃ©ploiement
            chmod +x deploy.sh
            ./deploy.sh

            # VÃ©rifier que les services sont dÃ©marrÃ©s
            docker-compose ps

            # Afficher les logs en cas de problÃ¨me
            if [ "$(docker-compose ps | grep -c 'Up')" -lt 3 ]; then
              echo "âŒ Certains services ne sont pas dÃ©marrÃ©s correctement"
              docker-compose logs
              exit 1
            else
              echo "âœ… Tous les services sont opÃ©rationnels"
            fi
          ENDSSH

      - name: Health check
        run: |
          # Attendre un peu que les services soient complÃ¨tement prÃªts
          sleep 60

          # Test de santÃ© de l'application
          if curl -f -s --max-time 30 http://${{ secrets.AZURE_VM_HOST }}/ > /dev/null; then
            echo "âœ… Application UI accessible"
          else
            echo "âŒ Application UI non accessible"
            exit 1
          fi

          if curl -f -s --max-time 30 http://${{ secrets.AZURE_VM_HOST }}:5000/swagger > /dev/null; then
            echo "âœ… API accessible"
          else
            echo "âŒ API non accessible"
            exit 1
          fi

      - name: Notify deployment success
        if: success()
        run: |
          echo "ğŸ‰ DÃ©ploiement rÃ©ussi!"
          echo "ğŸŒ Application disponible sur: http://${{ secrets.AZURE_VM_HOST }}"
          echo "ğŸ“š API Swagger: http://${{ secrets.AZURE_VM_HOST }}:5000/swagger"

      - name: Notify deployment failure
        if: failure()
        run: |
          echo "âŒ Ã‰chec du dÃ©ploiement"
          echo "Consultez les logs pour plus de dÃ©tails"